name: Tests

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]

jobs:
  test:
    name: Run Test Suite
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        # Future: Add macOS support
        # os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ZSH
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh

      - name: Install bats
        run: |
          sudo apt-get install -y bats

      - name: Setup test environment
        run: |
          echo "NIVUUS_SHELL_DIR=$GITHUB_WORKSPACE" >> $GITHUB_ENV

      - name: Run smoke tests
        run: |
          bats tests/unit/test_smoke.bats

      - name: Run unit tests
        run: |
          bats tests/unit/

      - name: Run performance tests (CRITICAL <300ms)
        run: |
          bats tests/performance/

      - name: Validate startup time requirement
        run: |
          # Extract startup time from performance tests
          output=$(bats tests/performance/test_startup.bats 2>&1)
          echo "$output"

          # Check if startup test passed or was skipped (both are OK)
          if echo "$output" | grep -q "ok 1 CRITICAL"; then
            if echo "$output" | grep -q "# skip"; then
              echo "‚è≠Ô∏è  Startup time test skipped in CI (use bin/benchmark locally)"
            else
              echo "‚úÖ Startup time requirement met (<300ms)"
            fi
          else
            echo "‚ùå Startup time requirement FAILED"
            exit 1
          fi

      - name: Test count validation
        run: |
          unit_count=$(bats tests/unit/ 2>&1 | head -1 | sed 's/1\.\.//')
          perf_count=$(bats tests/performance/ 2>&1 | head -1 | sed 's/1\.\.//')
          total=$((unit_count + perf_count))

          echo "Unit tests: $unit_count"
          echo "Performance tests: $perf_count"
          echo "Total: $total tests"

          # Minimum expected tests
          if [ "$total" -lt 100 ]; then
            echo "‚ùå Test count below minimum (expected ‚â•100, got $total)"
            exit 1
          fi

          echo "‚úÖ Test count: $total tests passing"

      - name: Generate test summary
        if: always()
        run: |
          echo "## Test Results üß™" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Run all tests and capture output
          if bats tests/unit/ tests/performance/ > test_results.txt 2>&1; then
            echo "‚úÖ All tests passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Some tests failed" >> $GITHUB_STEP_SUMMARY
          fi

          # Count tests
          unit_count=$(bats tests/unit/ 2>&1 | head -1 | sed 's/1\.\.//')
          perf_count=$(bats tests/performance/ 2>&1 | head -1 | sed 's/1\.\.//')
          total=$((unit_count + perf_count))

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Breakdown" >> $GITHUB_STEP_SUMMARY
          echo "- Unit tests: $unit_count" >> $GITHUB_STEP_SUMMARY
          echo "- Performance tests: $perf_count" >> $GITHUB_STEP_SUMMARY
          echo "- **Total: $total tests**" >> $GITHUB_STEP_SUMMARY

          # Extract startup time (if not skipped in CI)
          startup_output=$(bats tests/performance/test_startup.bats 2>&1 | grep "Average startup time" || true)
          if [ -n "$startup_output" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Performance ‚ö°" >> $GITHUB_STEP_SUMMARY
            echo "$startup_output" >> $GITHUB_STEP_SUMMARY
          fi

  lint:
    name: Syntax Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ZSH
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh

      - name: Validate ZSH syntax
        run: |
          echo "Validating .zshrc..."
          zsh -n .zshrc

          echo "Validating config files..."
          for file in config/*.zsh; do
            echo "  Checking $file..."
            zsh -n "$file"
          done

          echo "Validating theme files..."
          for file in themes/*.zsh; do
            echo "  Checking $file..."
            zsh -n "$file"
          done

          echo "‚úÖ All ZSH files have valid syntax"

  coverage:
    name: Test Coverage Report
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh bats

      - name: Setup environment
        run: |
          echo "NIVUUS_SHELL_DIR=$GITHUB_WORKSPACE" >> $GITHUB_ENV

      - name: Generate coverage report
        run: |
          echo "# Test Coverage Report" > coverage_report.md
          echo "" >> coverage_report.md
          echo "## Module Coverage" >> coverage_report.md
          echo "" >> coverage_report.md

          # List all test files and their test counts
          echo "| Test File | Tests |" >> coverage_report.md
          echo "|-----------|-------|" >> coverage_report.md

          for test_file in tests/unit/*.bats tests/performance/*.bats; do
            if [ -f "$test_file" ]; then
              count=$(bats "$test_file" 2>&1 | head -1 | sed 's/1\.\.//')
              basename=$(basename "$test_file")
              echo "| $basename | $count |" >> coverage_report.md
            fi
          done

          cat coverage_report.md

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage_report.md
