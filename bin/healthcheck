#!/usr/bin/env bash
# =============================================================================
# Nivuus Shell Health Check
# =============================================================================
# Comprehensive system and shell diagnostics
# =============================================================================

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Symbols
CHECK="${GREEN}✓${NC}"
CROSS="${RED}✗${NC}"
WARN="${YELLOW}⚠${NC}"
INFO="${BLUE}ℹ${NC}"

echo -e "${BLUE}═══════════════════════════════════════════${NC}"
echo -e "${BLUE}  Nivuus Shell - Health Check${NC}"
echo -e "${BLUE}═══════════════════════════════════════════${NC}"
echo ""

# =============================================================================
# System Information
# =============================================================================

echo -e "${BLUE}System Information${NC}"
echo "─────────────────────────────────────────────"

echo -n "OS: "
if [[ "$OSTYPE" == "darwin"* ]]; then
    echo "macOS $(sw_vers -productVersion 2>/dev/null || echo 'unknown')"
elif [[ -f /etc/os-release ]]; then
    . /etc/os-release
    echo "$NAME $VERSION"
else
    echo "$OSTYPE"
fi

echo "Hostname: $(hostname)"
echo "User: $(whoami)"
echo "Shell: $SHELL"
echo ""

# =============================================================================
# ZSH Installation
# =============================================================================

echo -e "${BLUE}ZSH Installation${NC}"
echo "─────────────────────────────────────────────"

if command -v zsh &>/dev/null; then
    echo -e "${CHECK} ZSH installed"
    echo "  Version: $(zsh --version | awk '{print $2}')"
    echo "  Location: $(command -v zsh)"
else
    echo -e "${CROSS} ZSH not found"
fi
echo ""

# =============================================================================
# Nivuus Shell
# =============================================================================

echo -e "${BLUE}Nivuus Shell${NC}"
echo "─────────────────────────────────────────────"

NIVUUS_DIR="${NIVUUS_SHELL_DIR:-$HOME/.nivuus-shell}"

if [[ -d "$NIVUUS_DIR" ]]; then
    echo -e "${CHECK} Nivuus Shell installed"
    echo "  Location: $NIVUUS_DIR"

    # Check config files
    config_count=$(ls -1 "$NIVUUS_DIR/config"/*.zsh 2>/dev/null | wc -l)
    echo "  Config files: $config_count/16"

    # Check .zshrc
    if [[ -f "$HOME/.zshrc" ]]; then
        if grep -q "NIVUUS_SHELL_DIR" "$HOME/.zshrc" 2>/dev/null; then
            echo -e "  ${CHECK} .zshrc configured"
        else
            echo -e "  ${WARN} .zshrc not configured for Nivuus"
        fi
    else
        echo -e "  ${CROSS} .zshrc not found"
    fi
else
    echo -e "${CROSS} Nivuus Shell not found at $NIVUUS_DIR"
fi
echo ""

# =============================================================================
# Core Dependencies
# =============================================================================

echo -e "${BLUE}Core Dependencies${NC}"
echo "─────────────────────────────────────────────"

check_command() {
    if command -v "$1" &>/dev/null; then
        echo -e "${CHECK} $1"
        [[ -n "$2" ]] && echo "  $($1 $2 2>/dev/null | head -1 | sed 's/^/  /')"
    else
        echo -e "${CROSS} $1 not found"
    fi
}

check_command "git" "--version"
check_command "curl" "--version | head -1"
check_command "vim" "--version | head -1"
echo ""

# =============================================================================
# Optional Tools
# =============================================================================

echo -e "${BLUE}Optional Tools${NC}"
echo "─────────────────────────────────────────────"

check_command "gemini-cli" "--version"
check_command "fd" "--version"
check_command "rg" "--version"
check_command "bat" "--version"
check_command "eza" "--version"
check_command "jq" "--version"
echo ""

# =============================================================================
# Node.js & NVM
# =============================================================================

echo -e "${BLUE}Node.js & NVM${NC}"
echo "─────────────────────────────────────────────"

if [[ -d "$HOME/.nvm" ]]; then
    echo -e "${CHECK} NVM installed"
    echo "  Location: $HOME/.nvm"

    # Try to load NVM and check version
    export NVM_DIR="$HOME/.nvm"
    if [[ -s "$NVM_DIR/nvm.sh" ]]; then
        source "$NVM_DIR/nvm.sh"
        echo "  NVM version: $(nvm --version 2>/dev/null || echo 'unknown')"

        if command -v node &>/dev/null; then
            echo -e "  ${CHECK} Node.js: $(node --version)"
            echo -e "  ${CHECK} npm: $(npm --version)"
        else
            echo -e "  ${WARN} No Node.js version active"
        fi
    fi
else
    echo -e "${CROSS} NVM not installed"
    echo "  Install: curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash"
fi
echo ""

# =============================================================================
# Disk Space
# =============================================================================

echo -e "${BLUE}Disk Space${NC}"
echo "─────────────────────────────────────────────"

df -h / | tail -1 | awk '{
    used = int($5);
    if (used < 80) {
        status = "'"${CHECK}"'";
    } else if (used < 90) {
        status = "'"${WARN}"'";
    } else {
        status = "'"${CROSS}"'";
    }
    printf "%s %s used (%s / %s)\n", status, $5, $3, $2;
}'
echo ""

# =============================================================================
# Memory
# =============================================================================

echo -e "${BLUE}Memory${NC}"
echo "─────────────────────────────────────────────"

if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS
    top -l 1 | grep PhysMem | sed 's/^/  /'
else
    # Linux
    free -h | grep Mem | awk '{printf "  Total: %s, Used: %s, Available: %s\n", $2, $3, $7}'
fi
echo ""

# =============================================================================
# Performance
# =============================================================================

echo -e "${BLUE}Performance${NC}"
echo "─────────────────────────────────────────────"

# Test shell load time
temp_file=$(mktemp)
cat > "$temp_file" << 'EOF'
#!/usr/bin/env zsh
start=$EPOCHREALTIME
source "$HOME/.zshrc"
end=$EPOCHREALTIME
duration=$(( ($end - $start) * 1000 ))
echo "$duration"
EOF

load_time=$(zsh "$temp_file" 2>/dev/null || echo "unknown")
rm -f "$temp_file"

if [[ "$load_time" != "unknown" ]]; then
    load_time_int=${load_time%.*}

    if (( load_time_int < 300 )); then
        echo -e "${CHECK} Shell load time: ${load_time}ms (excellent)"
    elif (( load_time_int < 500 )); then
        echo -e "${WARN} Shell load time: ${load_time}ms (good, target: <300ms)"
    else
        echo -e "${CROSS} Shell load time: ${load_time}ms (slow, target: <300ms)"
        echo "  Consider disabling features in ~/.zshrc:"
        echo "    export ENABLE_SYNTAX_HIGHLIGHTING=false"
        echo "    export ENABLE_PROJECT_DETECTION=false"
    fi
else
    echo -e "${WARN} Could not measure load time"
fi
echo ""

# =============================================================================
# Summary
# =============================================================================

echo -e "${BLUE}═══════════════════════════════════════════${NC}"
echo -e "${GREEN}Health check complete!${NC}"
echo -e "${BLUE}═══════════════════════════════════════════${NC}"
echo ""

# Suggestions
echo -e "${INFO} Suggestions:"

if ! command -v gemini-cli &>/dev/null; then
    echo "  • Install gemini-cli for AI commands: npm install -g gemini-cli"
fi

if [[ ! -d "$HOME/.nvm" ]]; then
    echo "  • Install NVM for Node.js management: nvm-install"
fi

if ! command -v fd &>/dev/null || ! command -v rg &>/dev/null; then
    echo "  • Install modern tools (fd, rg, bat): cargo install fd-find ripgrep bat"
fi

echo ""
