#!/usr/bin/env zsh
# =============================================================================
# Test Runner - Main entry point for running Nivuus Shell tests
# =============================================================================

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Test suite selection flags
RUN_UNIT=false
RUN_INTEGRATION=false
RUN_PERFORMANCE=false
RUN_E2E=false
RUN_ALL=true
VERBOSE=false
COVERAGE=false

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --unit|-u)
            RUN_UNIT=true
            RUN_ALL=false
            shift
            ;;
        --integration|-i)
            RUN_INTEGRATION=true
            RUN_ALL=false
            shift
            ;;
        --performance|-p)
            RUN_PERFORMANCE=true
            RUN_ALL=false
            shift
            ;;
        --e2e|-e)
            RUN_E2E=true
            RUN_ALL=false
            shift
            ;;
        --verbose|-v)
            VERBOSE=true
            shift
            ;;
        --coverage|-c)
            COVERAGE=true
            shift
            ;;
        --help|-h)
            cat <<EOF
Nivuus Shell Test Runner

Usage: ./bin/test [OPTIONS]

Options:
  -u, --unit          Run unit tests only
  -i, --integration   Run integration tests only
  -p, --performance   Run performance tests only
  -e, --e2e           Run end-to-end tests only
  -v, --verbose       Verbose output
  -c, --coverage      Generate coverage report
  -h, --help          Show this help message

Examples:
  ./bin/test                    # Run all tests
  ./bin/test --unit             # Run only unit tests
  ./bin/test --performance      # Run only performance tests
  ./bin/test --unit --verbose   # Run unit tests with verbose output

EOF
            exit 0
            ;;
        *)
            echo "${RED}Unknown option: $1${NC}"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

# Set RUN_ALL back to true if no specific suite selected
if ! $RUN_UNIT && ! $RUN_INTEGRATION && ! $RUN_PERFORMANCE && ! $RUN_E2E; then
    RUN_ALL=true
fi

# Check if bats is installed
if ! command -v bats &> /dev/null; then
    echo "${RED}✗ bats is not installed${NC}"
    echo "Install with: sudo apt install bats"
    exit 1
fi

# Project root
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$PROJECT_ROOT"

# Export project directory for tests
export NIVUUS_SHELL_DIR="$PROJECT_ROOT"

# Test results
TOTAL_TESTS=0
PASSED_TESTS=0
FAILED_TESTS=0

# Function to run test suite
run_test_suite() {
    local suite_name=$1
    local suite_path=$2

    echo "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo "${BLUE}Running $suite_name tests${NC}"
    echo "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

    local suite_results=$(mktemp)

    if [ -d "$suite_path" ]; then
        # Run bats on the entire suite directory
        if $VERBOSE; then
            bats --verbose-run "$suite_path" | tee "$suite_results"
        else
            bats "$suite_path" > "$suite_results" 2>&1
        fi

        local exit_code=$?
        cat "$suite_results"

        # Parse results (bats uses TAP format)
        local tests=$(grep -c "^ok\|^not ok" "$suite_results" || echo 0)
        local passed=$(grep -c "^ok" "$suite_results" || echo 0)
        local failed=$(grep -c "^not ok" "$suite_results" || echo 0)

        TOTAL_TESTS=$((TOTAL_TESTS + tests))
        PASSED_TESTS=$((PASSED_TESTS + passed))
        FAILED_TESTS=$((FAILED_TESTS + failed))

        rm "$suite_results"

        echo ""
        if [ $exit_code -eq 0 ]; then
            echo "${GREEN}✓ $suite_name: $passed/$tests tests passed${NC}"
        else
            echo "${RED}✗ $suite_name: $failed/$tests tests failed${NC}"
        fi
        echo ""

        return $exit_code
    else
        echo "${YELLOW}⚠ No tests found in $suite_path${NC}"
        echo ""
        return 0
    fi
}

# Start timestamp
START_TIME=$(date +%s)

echo "${GREEN}╔═══════════════════════════════════════════════════════════╗${NC}"
echo "${GREEN}║           Nivuus Shell Test Suite                        ║${NC}"
echo "${GREEN}╚═══════════════════════════════════════════════════════════╝${NC}"
echo ""

OVERALL_EXIT_CODE=0

# Run test suites based on flags
if $RUN_ALL || $RUN_UNIT; then
    if ! run_test_suite "Unit" "tests/unit"; then
        OVERALL_EXIT_CODE=1
    fi
fi

if $RUN_ALL || $RUN_INTEGRATION; then
    if ! run_test_suite "Integration" "tests/integration"; then
        OVERALL_EXIT_CODE=1
    fi
fi

if $RUN_ALL || $RUN_PERFORMANCE; then
    if ! run_test_suite "Performance" "tests/performance"; then
        OVERALL_EXIT_CODE=1
    fi
fi

if $RUN_ALL || $RUN_E2E; then
    if ! run_test_suite "End-to-End" "tests/e2e"; then
        OVERALL_EXIT_CODE=1
    fi
fi

# End timestamp and duration
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

# Final summary
echo "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo "${BLUE}Test Summary${NC}"
echo "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo "Total tests: $TOTAL_TESTS"
echo "${GREEN}Passed: $PASSED_TESTS${NC}"
if [ $FAILED_TESTS -gt 0 ]; then
    echo "${RED}Failed: $FAILED_TESTS${NC}"
else
    echo "Failed: $FAILED_TESTS"
fi
echo "Duration: ${DURATION}s"
echo ""

if [ $OVERALL_EXIT_CODE -eq 0 ]; then
    echo "${GREEN}✓ All tests passed!${NC}"
else
    echo "${RED}✗ Some tests failed${NC}"
fi

exit $OVERALL_EXIT_CODE
